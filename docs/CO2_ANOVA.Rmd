---
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
    encoding=encoding,
    output_file='CO2_ANOVA.md') })
output: github_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
options(width=100)
```

# Analyzing `CO2` with ANOVA and ANCOVA

In an ANOVA model each of our predictor variables are of the categorical type. 

A three factor ANOVA with interactions follows the following formula:

$${y_{ijkl} = {\mu}_{...} + {\alpha}_i + {\beta}_j + {\gamma}_k + (\alpha\beta)_{ij} + (\alpha\gamma)_{ik} + (\beta\gamma)_{jk} + (\alpha\beta\gamma)_{ijk} + {\epsilon}_{ijkl}}$$

Where:

- $y_{ijkl}$ is the response for $i$, $j$, and $k$ factor levels and $l$ observations,
- ${\mu}_{...}$ is the grand mean,
- ${\alpha}$, $\beta$, $\gamma$ are factors with $i$, $j$, and $k$ levels respectively,
- $(\alpha\beta)$, $(\alpha\gamma)$, $(\beta\gamma)$, and $(\alpha\beta\gamma)$ are interactions between the factors, and
- $\epsilon$ is the error term for $i$, $j$, and $k$ factor levels and $l$ observations.

In the `CO2` dataset the `conc` variable represents molecular concentrations of which are continuous, however because 7 distinct concentrations were used in this study it could be sensible to model `conc` as a categorical variable with 7 levels.  We can easily do this without making changes to the data by calling `factor()` on the variable within the model formula.  We can then use `summary()`, or alternatively `anova()`, to print out the ANOVA table for our fitted model.

```{r}
CO2.aov <- aov(uptake~Type*Treatment*factor(conc), data=CO2)

summary(CO2.aov)
```

*Note: Because linear regression and ANOVA are only different in language but not math, you could also use `aov()` on a previously fit `lm()` object.*

*Note: I have seen others suggest that both `aov()` and `anova()` fit an ANOVA model in `R`, but that is not exactly true.  While `anova()` prints an ANOVA table from a fitted model, only `aov()` actually fits an ANOVA model in base `R`.*

We can see that just like in the [linear regression model](https://tylerbg.github.io/CDAR/docs/CO2_LR) each of the three variables are statistically significant.

Because some of our interaction are not statistically significant we may want to remove them from the model to make a simpler, reduced model.  While we could rewrite our formula in `aov()` with only the significant factors and interaction we could also just use `update` to remove the insignificant interactions from the model we already fit.

```{r}
CO2.aov <- update(CO2.aov, .~.-Treatment:factor(conc)-Type:Treatment:factor(conc))

summary(CO2.aov)
```

But what if we did want to treat `conc` as a continuous variable?  While we could then fit a [linear regression model](https://tylerbg.github.io/CDAR/docs/CO2_LR), we could instead treat `conc` as a covariate in an ANCOVA.  In `R`, `aov()` will automatically treat a numerical variable as a covariate so we do not have to do much to change our code except leaving `conc` as a numerical variable.

```{r}
CO2.ancova <- aov(uptake~Type*Treatment*conc, data=CO2)

summary(CO2.ancova)
```

There is one issue here however in that both `summary()` and `anova()` in base `R` use the type I sum of squares.  With the ANCOVA we instead need to use the type III errors, otherwise we may be return incorrect statistical results and come to incorrect conclusions.  [While we can change from type I to III sum of squares in base `R`](https://mcfromnz.wordpress.com/2011/03/02/anova-type-iiiiii-ss-explained/) it is actually much easier to instead use the `Anova()` function from the `car` library to do this for us.

```{r}
#!if(require(car))(install.packages("car"))(library(car))

library(car)

Anova(CO2.ancova, type="3")
```


```{r}
CO2.ancova2 <- update(CO2.ancova, .~.-Type:Treatment:conc)

Anova(CO2.ancova2, type="3")
```







\newline
\newline

### Other Resources

[STHDA: One-Way ANOVA Test in R](http://www.sthda.com/english/wiki/one-way-anova-test-in-r)

[Scribbr: ANOVA in R: A step-by-step guide](https://www.scribbr.com/statistics/anova-in-r/)

[Data Analysis in R: Understanding ANOVA in R](https://bookdown.org/steve_midway/DAR/understanding-anova-in-r.html)

[Datanovia: ANOVA in R](https://www.datanovia.com/en/lessons/anova-in-r/)

[Applied Statistics with R: Analysis of Variance](https://daviddalpiaz.github.io/appliedstats/analysis-of-variance.html)